const container_json = {
  "tabs": [
    {
      "id": "tab1",
      "name": "etaHEN Menu", //https://github.com/etaHEN/etaHEN
      "buttons": [
        {
          "title": "etaHEN v2.5B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/etahen/etaHEN-2.5B.bin"
        },
        {
          "title": "etaHEN v2.4B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/etahen/etaHEN-2.4B.bin"
        },
        {
          "title": "etaHEN v2.3B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx"],
          "path": "payloads/etahen/etaHEN-2.3B.bin"
        },
        {
          "title": "etaHEN v2.2B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx"],
          "path": "payloads/etahen/etaHEN-2.2B.bin"
        },
        {
          "title": "etaHEN v2.1",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx"],
          "path": "payloads/etahen/etaHEN-2.1.bin"
        },
        {
          "title": "etaHEN v2.0B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx"],
          "path": "payloads/etahen/etaHEN-2.0B.bin"
        },
        {
          "title": "etaHEN v1.9B",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx"],
          "path": "payloads/etahen/etaHEN-1.9B.bin"
        },
        {
          "title": "etaHEN v1.9B without Toolbox",
          "icon": "\\uF13E",
          "dev": "By LM(LightningMods)",
          "desc": "etaHEN - AIO Homebrew enabler",
          "fw": ["1.xx","2.xx","3.xx","4.xx"],
          "path": "payloads/etahen/etaHEN-1.9B_no_tb.bin"
        },
      ]
    },
    {
      "id": "tab2",
      "name": "Kstuff Menu", //https://github.com/EchoStretch/kstuff
      "buttons": [
        {
          "title": "Kstuff v1.6.7",
          "icon": "\\uF09C",
          "dev": "By sleirsgoevy/EchoStretch",
          "desc": "Homebrew enabler,Can Install and Run PS4 FPKGs,Support Dump Installer and Run PS4/5 Dump Games",
          "fw": ["3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/kstuff/kstuff-1.6.7.elf"
        },
        {
          "title": "Kstuff Lite v1.00",
          "icon": "\\uF09C",
          "dev": "By sleirsgoevy/EchoStretch",
          "desc": "Homebrew enabler,Can Install and Run PS4 FPKGs,Support Dump Installer and Run PS4/5 Dump Games<br>This Payload Doesnt Need kstuff Toggle for running some Games",
          "fw": ["3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/kstuff/kstuff-lite-1.00.elf"
        },
        {
          "title": "Kstuff v1.6.6",
          "icon": "\\uF09C",
          "dev": "By sleirsgoevy/EchoStretch",
          "desc": "Homebrew enabler,Can Install and Run PS4 FPKGs, Run PS4/5 Dump Games",
          "fw": ["3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/kstuff/kstuff-1.6.6.elf"
        },
        {
          "title": "Kstuff v1.6.5",
          "icon": "\\uF09C",
          "dev": "By sleirsgoevy/EchoStretch",
          "desc": "Homebrew enabler,Can Install and Run PS4 FPKGs, Run PS4/5 Dump Games",
          "fw": ["3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx"],
          "path": "payloads/kstuff/kstuff-1.6.5.elf"
        },
      ]
    },
    {
      "id": "tab3",
      "name": "Main Tools",
      "buttons": [
        {
          "title": "websrv v0.29", //https://github.com/ps5-payload-dev/websrv
          "icon": "\\uF6FF",
          "dev": "By john-tornblom",
          "desc": "A simple web server for jailbroken PS5s that accepts connections on port 8080",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/websrv-ps5.elf"
        },
        {
          "title": "BackPork v0.1", //https://github.com/BestPig/BackPork
          "icon": "\\uF706", 
          "dev": "by BestPig",
          "desc": "Lets you sideload system libraries into PS5 games",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/ps5-backpork.elf"
        },
        {
          "title": "Sentinel Warden(Kstuff warden) v1.00", //https://github.com/voidwhisper-ps
          "icon": "\\uF017", 
          "dev": "by VoidWhisper",
          "desc": "Auto Toggle kstuff Payload",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/sentinel_warden_installer.elf"
        },
        {
          "title": "ShadowMount v1.4", //https://github.com/Jamzi94/ShadowMount
          "icon": "\\uF56D", 
          "dev": "by VoidWhisper/Jamzi",
          "desc": "ShadowMount automatically detects, mounts, and installs game dumps from both internal and external storage.<br>Supports all Jailbroken PS5 firmwares running Kstuff v1.6.7",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/shadowmount.elf"
        },
        {
          "title": "ftpsrv v0.18.1", //https://github.com/ps5-payload-dev/ftpsrv
          "icon": "\\uF883",
          "dev": "By john-tornblom",
          "desc": "A simple FTP server for jailbroken PS5s. The FTP server accepts connection on port 2121.",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/ftpsrv-ps5.elf"
        },
        {
          "title": "elfldr v0.21.2", //https://github.com/ps5-payload-dev/elfldr
          "icon": "\\uF310",
          "dev": "By john-tornblom",
          "desc": "An ELF loader for jailbroken PS5s that accepts payloads on port 9021",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/elfldr-ps5.elf"
        },
      ]
    },
    {
      "id": "tab4",
      "name": "Other Tools",
      "buttons": [
        {
          "title": "PS5HEN (Byepervisor) v1.1", //https://github.com/EchoStretch/Byepervisor
          "icon": "\\uF3C2",
          "dev": "By ChendoChap, flatz, fail0verflow, Znullptr, kiwidog, sleirsgoevy, EchoStretch",
          "desc": "A PS5 hypervisor exploit for 1.xx-2xx firmwares.",
          "fw": ["1.xx","2.xx"],
          "path": "payloads/tools/byepervisor.elf"
        },
        {
          "title": "Kstuff Toggle v0.4 Beta<br>Both PS4 and PS5 sysentvec", //https://github.com/EchoStretch/kstuff-toggle
          "icon": "\\uF205", 
          "dev": "By EchoStretch",
          "desc": "Boost homebrew game performance on your PS5 by disabling Kstuff after launching the game.<br>Requires sending the payload via netcat or using the Homebrew Launcher with the Websrv payload.",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/kstuff-toggle-3.elf"
        },
        {
          "title": "Kstuff Toggle v0.4 Beta<br>PS5 sysentvec", //https://github.com/EchoStretch/kstuff-toggle
          "icon": "\\uF205", 
          "dev": "By EchoStretch",
          "desc": "Boost homebrew game performance on your PS5 by disabling Kstuff after launching the game.<br>Requires sending the payload via netcat or using the Homebrew Launcher with the Websrv payload.",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/kstuff-toggle-1.elf"
        },
        {
          "title": "Kstuff Toggle v0.4 Beta<br>PS4 sysentvec", //https://github.com/EchoStretch/kstuff-toggle
          "icon": "\\uF205", 
          "dev": "By EchoStretch",
          "desc": "Boost homebrew game performance on your PS5 by disabling Kstuff after launching the game.<br>Requires sending the payload via netcat or using the Homebrew Launcher with the Websrv payload.",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/kstuff-toggle-2.elf"
        },
        {
          "title": "NP Fake Signin v1.1", //https://github.com/earthonion/np-fake-signin
          "icon": "\\uF5AC", 
          "dev": "By earthonion",
          "desc": "Sets PSN state to \"signed in\" on PS5<br>First use offact homebrew to active your user,Then use this payload",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/np-fake-signin-ps4.elf"
        },
        {
          "title": "gdbsrv v0.7.3", //https://github.com/ps5-payload-dev/gdbsrv
          "icon": "\\uF1C9",
          "dev": "By john-tornblom",
          "desc": "A simple GDB server for jailbroken PS4s and PS5s,The server accepts connections on port 2159",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/gdbsrv-ps5.elf"
        },
        {
          "title": "klogsrv v0.7.1", //https://github.com/ps5-payload-dev/klogsrv
          "icon": "\\uF1C9",
          "dev": "By john-tornblom",
          "desc": "A simple socket server for jailbroken PS4s and PS5s that redirects /dev/klog to sockets connected on port 3232",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/klogsrv-ps5.elf"
        },
        {
          "title": "shsrv v0.18",
          "icon": "\\uF1C9",
          "dev": "By john-tornblom",
          "desc": "A simple telnet-like shell server for jailbroken PS5s that accepts connections on port 2323",
          "fw": ["1.xx","2.xx","3.xx","4.xx", "5.xx", "6.xx", "7.xx", "8.xx","9.xx","10.00","10.01"],
          "path": "payloads/tools/shsrv-ps5.elf"
        },
        {
          "title": "libhijacker v1.160", //https://github.com/illusion0001/libhijacker-game-patch
          "icon": "\\uF316",
          "dev": "By astrelsky/illusion0001",
          "desc": "Patches supported games to run at higher framerates, and adds debug menus to certain titles.",
          "fw": ["3.xx","4.xx"],
          "path": "payloads/tools/libhijacker.elf"
        },
        {
          "title": "ps5-versions v1.0", //https://github.com/SiSTR0/ps5-versions
          "icon": "\\uF30F",
          "dev": "By SiSTR0",
          "desc": "Shows kernel build, os and sdk versions",
          "fw": ["1.xx","2.xx","3.xx","4.xx"],
          "path": "payloads/tools/ps5-versions.elf"
        },
        {
          "title": "ps5debug v0.0.1-r2", //https://github.com/idlesauce/ps5debug
          "icon": "\\uF1C9",
          "dev": "By DizzRL/idlesauce",
          "desc": "USB tools",
          "fw": ["1.xx","2.xx","3.xx","4.xx","5.xx"],
          "path": "payloads/tools/ps5debug.elf"
        },
        {
          "title": "App Dumper 1.08 Beta", //https://github.com/EchoStretch/ps5-app-dumper
          "icon": "\\uF56E",
          "dev": "By EchoStretch",
          "desc": "A small utility to dump PS5 application files from the console's pfsmnt to a connected USB storage device.<br>This project builds into an ELF payload that runs on the PS5 and copies the app files to a mounted USB drive<br>it does not support network transfers.",
          "fw": ["1.xx","2.xx","3.xx","4.xx","5.xx"],
          "path": "payloads/tools/ps5-app-dumper.elf"
        }
      ]
    }
  ]
};

// ==========================================
// 1. Firmware detection function (separated from logic error)
// ==========================================
function getSystemFirmware() {
    const ua = navigator.userAgent;
    const fw_idx = ua.indexOf('PlayStation; PlayStation 5/');
    
    if (fw_idx >= 0) {
    // Extract firmware (e.g. "4.03")
        return ua.substring(fw_idx + 27, fw_idx + 27 + 4);
    }
    
    // If you are testing on a computer or the firmware is not found
    // You can change the value below for manual testing (e.g. return "4.03";)
    return "Unknown"; 
}

// ==========================================
// 2. Compatibility Check Function (Your Main Logic)
// ==========================================
function isFirmwareCompatible(buttonFwList, currentFw) {
    // If the firmware list was empty or had an All button, display it
    if (!buttonFwList || buttonFwList.length === 0 || buttonFwList.includes("All")) {
        return true;
    }

    // If the system firmware was unknown (e.g. on a PC), show all (or you can set it to false)
    if (currentFw === "Unknown") return true;

    for (let reqFw of buttonFwList) {
        // Mode 1: Check for generic firmware like "4.xx"
        if (reqFw.includes("xx")) {
            const baseFw = reqFw.replace("xx", ""); // Convert "4.xx" to "4."
            if (currentFw.startsWith(baseFw)) {
                return true;
            }
        }
        // Mode 2: Check exact firmware like "4.03"
        else {
            if (currentFw === reqFw) {
                return true;
            }
        }
    }

    return false;
}


// ==========================================
// 3. Function to send payload to WebSrv (WebSrv Loader)
// ==========================================
async function loadAndSendPayload(path, title) {

    try {
        // 1. Download the file from our host
        const dlResponse = await fetch(path);
        
        if (!dlResponse.ok) {
            throw new Error(`Failed to download payload from host: ${path}`);
        }
        
        const payloadBlob = await dlResponse.blob();

        // 2. Extract file name from path
        // For example, if path is "/payloads/vtx.elf", fileName will be "vtx.elf"
        const fileName = path.split('/').pop();

        // 3. Preparing the form for submission
        let formData = new FormData();
        
        // The field name must be "elf" so that the console recognizes it
        // But we set the file name (third argument) to the original file name
        formData.append("elf", payloadBlob, fileName);

        // 4. Send to console port 8080
        const elfUrl = "http://127.0.0.1:8080/elfldr";
        
        const elfResponse = await fetch(elfUrl, {
            method: "POST",
            body: formData
        });

        if (elfResponse.ok || elfResponse.status === 200) {
            alert(`${title} Sent Successfully!`);
        } else {
            alert(`WebSrv Response Error: ${elfResponse.status}`);
        }

    } catch (error) {
        console.error(error);
        alert(`Error: ${error.message}\nEnsure WebSrv is running on 8080.`);
    }
}


// ==========================================
// 4. Container construction (modified for filtering)
// ==========================================
function buildContainerFromJSON() {
  const currentFw = getSystemFirmware();

  const container = document.querySelector('.container');
  container.innerHTML = ''; // Clear the container to prevent duplication

  // Display firmware in header (optional - for beauty)
  const fwDisplay = document.createElement('div');
  fwDisplay.className = 'server-info';
  fwDisplay.style.marginBottom = '15px';
  fwDisplay.style.display = 'block';
  fwDisplay.style.textAlign = 'center';
  fwDisplay.innerHTML = `Detected Firmware: <span style="color: #fff; font-weight: bold;">${currentFw}</span>`;
  container.appendChild(fwDisplay);
  
  // Create tabs container
  const tabsContainer = document.createElement('div');
  tabsContainer.className = 'tabs-container';
  
  const l1Button = document.createElement('div');
  l1Button.className = 'tab-helper';
  l1Button.textContent = 'L1';
  tabsContainer.appendChild(l1Button);
  
  // Create main tabs
  container_json.tabs.forEach((tab, tabIndex) => {
    
    // Create tab button
    const tabButton = document.createElement('button');
    tabButton.className = `tab ${tabIndex === 0 ? 'active' : ''}`;
    tabButton.setAttribute('data-tab', tab.id);
    tabButton.textContent = tab.name;
    tabsContainer.appendChild(tabButton);
    
    // Create tab content
    const tabContent = document.createElement('div');
    tabContent.className = `tab-content ${tabIndex === 0 ? 'active' : ''}`;
    tabContent.id = tab.id;
    
    const menuContainer = document.createElement('div');
    menuContainer.className = 'menu-container';
    menuContainer.id = `menu-container-${tab.id}`;
    
    const menu = document.createElement('div');
    menu.className = 'menu';
    menu.id = `menu-${tab.id}`;

    const topIndicator = document.createElement('div');
    topIndicator.className = 'menu-indicator';
    topIndicator.innerHTML = 'Press <span style="font-size:1.2em; vertical-align:middle;">▲</span> to go to the last item';
    menu.appendChild(topIndicator);
  
    // ============================================================
    // *Important* Create buttons with firmware check condition
    // ============================================================
    let validButtonCount = 0; // Count of valid buttons for correct indexing

    tab.buttons.forEach((button) => {
      // Here we check whether this button should be displayed or not
      if (isFirmwareCompatible(button.fw, currentFw)) {
          
          const menuBtn = document.createElement('button');
          // Active class only for the first button of the first tab
          menuBtn.className = `menu-btn ${tabIndex === 0 && validButtonCount === 0 ? 'active' : ''}`;
          
          // *Important* We give the index based on validButtonCount, not the main loop index
          // because if a button is removed, the order of the indices should not be messed up (for keyboard navigation)
          menuBtn.setAttribute('data-index', validButtonCount);
          menuBtn.setAttribute('data-tab', tab.id);
          menuBtn.setAttribute('data-path', button.path);
          menuBtn.setAttribute('data-fw', JSON.stringify(button.fw));
          
          let iconChar = button.icon;
          if (button.icon.startsWith('\\u')) {
            iconChar = String.fromCharCode(parseInt(button.icon.replace('\\u', ''), 16));
          }
          
          menuBtn.innerHTML = `
            <span class="icon-char">${iconChar}</span>
            <div class="menu-btn-title">${button.title}</div>
            ${button.dev ? `<div class="menu-btn-desc">${button.dev}</div>` : ''}
            <div class="menu-btn-desc">${button.desc}</div>
          `;

          menuBtn.addEventListener('click', function() {
              const payloadPath = this.getAttribute('data-path');
              const payloadTitle = button.title;
              
              if (payloadPath) {
                  // Call the function we created in step 1
                  loadAndSendPayload(payloadPath, payloadTitle);
              } else {
                  console.error("No path defined for this payload.");
              }
          });

          menu.appendChild(menuBtn);
          validButtonCount++; // Increment the counter of created buttons
      }
    });

    // Display a message if there is no button for the current firmware in this tab
    if (validButtonCount === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.gridColumn = "1 / -1";
        emptyMsg.style.textAlign = "center";
        emptyMsg.style.padding = "20px";
        emptyMsg.style.color = "#777";
        emptyMsg.innerHTML = "No payloads available for your firmware in this category.";
        menu.appendChild(emptyMsg);
    }

    const bottomIndicator = document.createElement('div');
    bottomIndicator.className = 'menu-indicator';
    bottomIndicator.innerHTML = 'Press <span style="font-size:1.2em; vertical-align:middle;">▼</span> to go to the first item';
    menu.appendChild(bottomIndicator);
    
    menuContainer.appendChild(menu);
    tabContent.appendChild(menuContainer);
    container.appendChild(tabContent);
  });
  
  const r1Button = document.createElement('div');
  r1Button.className = 'tab-helper';
  r1Button.textContent = 'R1';
  tabsContainer.appendChild(r1Button);
  
  // Insert tabs after the firmware display
  container.appendChild(tabsContainer); // Here, because we appendChild, it goes to the bottom of the list, it needs to be corrected.
  
  // Modify the DOM order:
  // We added fwDisplay first, now we need to put tabsContainer before the first tab-content
  // Or simpler: we rearranged the entire container. It's okay because fwDisplay was added first, then tabContents were added.
  // So we just need to move tabsContainer below fwDisplay.
  container.insertBefore(tabsContainer, container.children[1]); // This line puts it after fwDisplay
  
  window.container_json = container_json;
}

document.addEventListener('DOMContentLoaded', function() {
  buildContainerFromJSON();
});



